---
import Header from "@/components/sections/Header.astro";
import HeroSection from "@/components/sections/HeroSection.astro";
import FeaturesSection from "@/components/sections/FeaturesSection.astro";
import TestimonialCard from "@/components/sections/TestimonialCard.astro";
import DetailedFeatures from "@/components/sections/DetailedFeatures.astro";
import FaqSection from "@/components/sections/FaqSection";
import RichTextSection from "@/components/sections/RichTextSection.astro";
import Footer from "@/components/sections/Footer.astro";
import { client } from "@/lib/sanity";
import {
  navItems as localNavItems,
  footerColumns as localFooterColumns,
} from "@/lib/navigation";

interface Props {
  page: any;
}

const { page } = Astro.props;

// Fetch global chrome (nav + footer)
let navItems: any[] = [];
let footerColumns: any[] = [];

try {
  [navItems, footerColumns] = await Promise.all([
    client.fetch(`*[_type == "navItem"] | order(order asc){
      label, href, wide, children[]{ label, href, description }
    }`),
    client.fetch(`*[_type == "footerColumn"] | order(order asc){
      title, lightTitle, links[]{ label, href }
    }`),
  ]);
} catch (e) {
  console.warn("Sanity fetch failed for global chrome, using fallback:", e);
}

const resolvedNavItems = navItems?.length
  ? navItems.map((n: any) =>
      n.children?.length
        ? { label: n.label, items: n.children, wide: n.wide }
        : { label: n.label, href: n.href || "#" },
    )
  : localNavItems;

const resolvedFooterColumns = footerColumns?.length
  ? footerColumns.map((c: any) => ({
      title: c.title,
      lightTitle: c.lightTitle,
      links: c.links || [],
    }))
  : localFooterColumns;

// Filter to enabled sections
const sections = (page.sections || []).filter(
  (s: any) => s.enabled !== false,
);
---

<Header navItems={resolvedNavItems} />

{sections.map((section: any) => {
  switch (section._type) {
    case "heroBlock":
      return <HeroSection hero={section} />;
    case "featuresBlock":
      return (
        <FeaturesSection
          features={{
            title: section.title,
            subtitle: section.subtitle,
            cards: section.cards,
          }}
        />
      );
    case "testimonialBlock":
      return (
        <section class="relative z-[2] px-4 pb-2 bg-brand-800">
          <div class="max-w-[1920px] mx-auto bg-white rounded-3xl py-16 lg:py-24 overflow-hidden flex flex-col">
            <TestimonialCard testimonial={section} />
          </div>
        </section>
      );
    case "detailRowsBlock":
      return <DetailedFeatures detailRows={section.rows} />;
    case "faqBlock":
      return <FaqSection items={section.items} client:visible />;
    case "richTextBlock":
      return <RichTextSection body={section.body} />;
    default:
      return null;
  }
})}

<Footer columns={resolvedFooterColumns} />
