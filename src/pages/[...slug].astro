---
import BaseLayout from "@/layouts/BaseLayout.astro";
import PageRenderer from "@/components/PageRenderer.astro";
import { client } from "@/lib/sanity";

export async function getStaticPaths() {
  const pages = await client.fetch(
    `*[_type == "page" && defined(slug.current)]{
      "slug": slug.current
    }`,
  );

  return pages.map((p: any) => ({
    params: { slug: p.slug },
  }));
}

const { slug } = Astro.params;

const page = await client.fetch(
  `*[_type == "page" && slug.current == $slug][0]{
    title,
    slug,
    seoDescription,
    sections[]{
      _type,
      _key,
      enabled,
      // heroBlock fields
      _type == "heroBlock" => {
        eyebrow, title, description, ctaText,
        screenshot{ asset->{url} },
        catalogThumb{ asset->{url} },
        backgroundPattern{ asset->{url} },
        glowLine{ asset->{url} }
      },
      // featuresBlock fields
      _type == "featuresBlock" => {
        title, subtitle,
        cards[]{ icon{ asset->{url} }, title, description }
      },
      // testimonialBlock fields
      _type == "testimonialBlock" => {
        avatar{ asset->{url} },
        name, role, source, rating, quote, highlightText
      },
      // detailRowsBlock fields
      _type == "detailRowsBlock" => {
        rows[]{
          eyebrow, title, description, bullets, ctaText, reverse, visualType,
          images[]{ asset->{url} }
        }
      },
      // faqBlock fields
      _type == "faqBlock" => {
        items[]{ question, answer }
      },
      // richTextBlock fields
      _type == "richTextBlock" => {
        body[]{ ..., asset->{url} }
      }
    }
  }`,
  { slug },
);

if (!page) {
  return Astro.redirect("/404");
}
---

<BaseLayout
  title={page.title ? `${page.title} â€” Handoff` : "Handoff"}
  description={page.seoDescription}
>
  <PageRenderer page={page} />
</BaseLayout>

<script>
  import { initScrollAnimations } from "@/lib/animations";

  const header = document.getElementById("site-header");
  const heroContainer = document.getElementById("hero-container");
  const heroSection = document.getElementById("hero");
  const heroSpacer = document.getElementById("hero-spacer");
  const features = document.getElementById("features");

  function setSpacerHeight() {
    if (heroSection && heroSpacer) {
      heroSpacer.style.height = heroSection.offsetHeight + "px";
    }
  }

  if (heroSection) {
    setSpacerHeight();
    window.addEventListener("resize", setSpacerHeight);
  }

  window.addEventListener("scroll", () => {
    const scrollY = window.scrollY;

    if (header) {
      if (scrollY > 40) {
        header.classList.add("header-scrolled");
      } else {
        header.classList.remove("header-scrolled");
      }
    }

    if (heroContainer) {
      const fadeEnd = window.innerHeight * 0.5;
      const progress = Math.min(Math.max(scrollY / fadeEnd, 0), 1);
      heroContainer.style.opacity = String(1 - progress);
      heroContainer.style.transform = `translateY(${progress * -40}px)`;
    }

    if (features && heroSection) {
      const heroBottom = heroSection.offsetHeight;
      if (scrollY >= heroBottom) {
        features.classList.add("features-solid-bg");
      } else {
        features.classList.remove("features-solid-bg");
      }
    }
  });

  initScrollAnimations();
</script>
