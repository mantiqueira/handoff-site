---
import BaseLayout from "@/layouts/BaseLayout.astro";
import Header from "@/components/sections/Header.astro";
import HeroSection from "@/components/sections/HeroSection.astro";
import FeaturesSection from "@/components/sections/FeaturesSection.astro";
import DetailedFeatures from "@/components/sections/DetailedFeatures.astro";
import FaqSection from "@/components/sections/FaqSection";
import Footer from "@/components/sections/Footer.astro";
import { client, urlFor } from "@/lib/sanity";
import { navItems as localNavItems, footerColumns as localFooterColumns, faqItems as localFaqItems } from "@/lib/navigation";

// Fetch all content from Sanity
let hero: any = null;
let features: any = null;
let testimonial: any = null;
let detailRows: any[] = [];
let faqItems: any[] = [];
let footerColumns: any[] = [];
let navItems: any[] = [];

try {
  [hero, features, testimonial, detailRows, faqItems, footerColumns, navItems] = await Promise.all([
    client.fetch(`*[_type == "heroSection"][0]{
      eyebrow, title, description, ctaText,
      screenshot{ asset->{url} },
      catalogThumb{ asset->{url} },
      backgroundPattern{ asset->{url} },
      glowLine{ asset->{url} }
    }`),
    client.fetch(`*[_type == "featuresSection"][0]{
      title, subtitle,
      cards[]{ icon{ asset->{url} }, title, description }
    }`),
    client.fetch(`*[_type == "testimonial"][0]{
      avatar{ asset->{url} },
      name, role, source, rating, quote, highlightText
    }`),
    client.fetch(`*[_type == "detailRow"] | order(order asc){
      eyebrow, title, description, bullets, ctaText, reverse, visualType,
      images[]{ asset->{url} }
    }`),
    client.fetch(`*[_type == "faqItem"] | order(order asc){ question, answer }`),
    client.fetch(`*[_type == "footerColumn"] | order(order asc){
      title, lightTitle, links[]{ label, href }
    }`),
    client.fetch(`*[_type == "navItem"] | order(order asc){
      label, href, wide, children[]{ label, href, description }
    }`),
  ]);
} catch (e) {
  console.warn("Sanity fetch failed, using local fallback data:", e);
}

// Build FAQ items with fallback
const resolvedFaqItems = faqItems?.length
  ? faqItems.map((f: any) => ({ question: f.question, answer: f.answer }))
  : localFaqItems;

// Build footer columns with fallback
const resolvedFooterColumns = footerColumns?.length
  ? footerColumns.map((c: any) => ({
      title: c.title,
      lightTitle: c.lightTitle,
      links: c.links || [],
    }))
  : localFooterColumns;

// Build nav items with fallback
const resolvedNavItems = navItems?.length
  ? navItems.map((n: any) =>
      n.children?.length
        ? { label: n.label, items: n.children, wide: n.wide }
        : { label: n.label, href: n.href || "#" }
    )
  : localNavItems;
---

<BaseLayout title="Handoff â€” Construction-Trained AI for Sales and Lead Intake">
  <Header navItems={resolvedNavItems} />
  <HeroSection hero={hero} />
  <FeaturesSection features={features} testimonial={testimonial} />
  <DetailedFeatures detailRows={detailRows} />
  <FaqSection items={resolvedFaqItems} client:visible />
  <Footer columns={resolvedFooterColumns} />
</BaseLayout>

<script>
  import { initScrollAnimations } from "@/lib/animations";

  const header = document.getElementById("site-header");
  const heroContainer = document.getElementById("hero-container");
  const heroSection = document.getElementById("hero");
  const heroSpacer = document.getElementById("hero-spacer");
  const features = document.getElementById("features");

  function setSpacerHeight() {
    if (heroSection && heroSpacer) {
      heroSpacer.style.height = heroSection.offsetHeight + "px";
    }
  }

  setSpacerHeight();
  window.addEventListener("resize", setSpacerHeight);

  window.addEventListener("scroll", () => {
    const scrollY = window.scrollY;

    // Header scroll state
    if (header) {
      if (scrollY > 40) {
        header.classList.add("header-scrolled");
      } else {
        header.classList.remove("header-scrolled");
      }
    }

    // Hero fade + parallax
    if (heroContainer) {
      const fadeEnd = window.innerHeight * 0.5;
      const progress = Math.min(Math.max(scrollY / fadeEnd, 0), 1);
      heroContainer.style.opacity = String(1 - progress);
      heroContainer.style.transform = `translateY(${progress * -40}px)`;
    }

    // Features solid background
    if (features && heroSection) {
      const heroBottom = heroSection.offsetHeight;
      if (scrollY >= heroBottom) {
        features.classList.add("features-solid-bg");
      } else {
        features.classList.remove("features-solid-bg");
      }
    }
  });

  // Initialize GSAP scroll animations
  initScrollAnimations();
</script>
